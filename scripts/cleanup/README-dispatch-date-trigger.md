# 施工队与派工日期关联触发器部署指南

## 功能说明

此触发器确保施工队与派工日期之间的数据一致性，实现以下业务规则：

1. 当施工队字段为空时，派工日期会自动设置为空
2. 当施工队字段从空变为有值时，派工日期会自动设置为当前日期

## 部署步骤

1. 登录到 Supabase 管理控制台
2. 点击左侧菜单中的 **SQL 编辑器**
3. 创建一个新的查询
4. 将 `scripts/cleanup/deploy_dispatch_date_consistency_trigger.sql` 文件中的内容复制到查询编辑器中
5. 点击 **运行** 按钮执行脚本
6. 查看执行结果，确保最后显示 "触发器已创建: 施工队与派工日期的数据一致性将自动维护"

## 效果验证

部署成功后，您可以通过以下方式验证触发器是否生效：

1. 在客户列表或客户表单中，尝试清空某个客户的施工队字段，并保存
2. 检查该客户的派工日期字段，确认它已自动变为空
3. 为某个没有施工队的客户添加施工队信息，并保存
4. 检查该客户的派工日期字段，确认它已自动设置为当前日期

## 注意事项

- 此触发器在**数据库层面**保证了数据一致性，无论通过何种前端操作都将遵循这些规则
- 触发器部署后会自动修复现有数据中不符合规则的记录
- 如需卸载此触发器，请在SQL编辑器中执行以下命令：
  ```sql
  DROP TRIGGER IF EXISTS ensure_dispatch_date_consistency ON customers;
  DROP FUNCTION IF EXISTS ensure_dispatch_date_consistency();
  ``` 