# 采购工作台功能更新指南

## 概述

采购工作台已更新，新增了以下功能：

1. 将材料数据存储在数据库中，实现数据持久化
2. 采用数据缓存+异步更新模式，提高响应速度
3. 在每户用料栏后增加"仓库余料"列，可编辑
4. 在总用料栏后增加"实际采购"列，自动计算（总用料-仓库余料）
5. 实时显示未保存的更改，并允许手动同步

## 应用更新

### 步骤1：创建数据库表和函数

运行以下命令以应用数据库迁移：

```bash
npm run apply-procurement-migrations
```

这将执行以下操作：
- 创建采购材料表 `procurement_materials`
- 创建批量更新功能的函数 `batch_update_materials`
- 添加默认的材料数据

### 步骤2：更新应用程序

重新启动应用程序：

```bash
npm run dev
```

## 新功能说明

### 数据缓存和异步更新

- 当编辑材料信息时，更改会立即保存在本地缓存中
- 有未保存的更改时，对应行前面会显示同步图标
- 更改会在3秒后自动同步到数据库
- 可以点击"立即同步"按钮手动触发同步
- 如果同步失败，系统会每5秒自动重试

### 仓库余料和实际采购

- "仓库余料"列：记录当前仓库中已有的材料数量，可以点击编辑
- "实际采购"列：系统自动计算需要采购的数量（总用料 - 仓库余料）
- 总价计算逻辑更新：现在基于实际采购量，而不是总用料量

### 导出Excel

Excel导出功能已更新，包含新增的"仓库余料"和"实际采购"列。

## 技术实现

- 使用防抖（debounce）技术减少频繁的数据库更新
- 使用乐观更新策略，先更新UI，然后异步更新数据库
- 对连续的更新进行批处理，减少数据库操作次数
- 实现错误重试机制，确保数据最终一致性 